<?php
session_start();

// Database connection
require_once '../config/database.php';

// Check if user is logged in
if (!isset($_SESSION['user_id'])) {
    header('Location: ../auth/login.php');
    exit();
}

$user = [
    'name' => $_SESSION['user_name'] ?? 'Admin User',
    'email' => $_SESSION['user_email'] ?? 'admin@ciudaddesanjose.com',
    'role' => $_SESSION['user_role'] ?? 'Administrator'
];

// Fetch dashboard statistics
try {
    // Total Homeowners
    $stmt = $pdo->query("SELECT COUNT(*) as total FROM homeowners WHERE status = 'active'");
    $totalHomeowners = $stmt->fetch(PDO::FETCH_ASSOC)['total'] ?? 0;
    
    // Currently Inside
    $stmt = $pdo->query("SELECT COUNT(*) as total FROM homeowners WHERE current_status = 'IN' AND status = 'active'");
    $currentlyInside = $stmt->fetch(PDO::FETCH_ASSOC)['total'] ?? 0;
    
    // Currently Outside
    $currentlyOutside = $totalHomeowners - $currentlyInside;
    
    // Total Entries Today
    $stmt = $pdo->query("SELECT COUNT(*) as total FROM entry_logs WHERE action = 'IN' AND DATE(timestamp) = CURDATE()");
    $totalEntriesToday = $stmt->fetch(PDO::FETCH_ASSOC)['total'] ?? 0;
    
    // Total Exits Today
    $stmt = $pdo->query("SELECT COUNT(*) as total FROM entry_logs WHERE action = 'OUT' AND DATE(timestamp) = CURDATE()");
    $totalExitsToday = $stmt->fetch(PDO::FETCH_ASSOC)['total'] ?? 0;
    
} catch (PDOException $e) {
    // Default values if database error
    $totalHomeowners = 0;
    $currentlyInside = 0;
    $currentlyOutside = 0;
    $totalEntriesToday = 0;
    $totalExitsToday = 0;
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Subdivision Entry & Exit Monitoring</title>
    <meta name="description" content="Monitor homeowner entry and exit activity in real-time for Ciudad de San Jose subdivision">
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="dashboard.css">
    
    <style>
        :root {
            --primary-color: #6366f1;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            --dark-bg: #0f172a;
            --card-bg: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
        }
        
        .status-badge-in {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }
        
        .status-badge-out {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }
        
        .activity-log-row {
            transition: all 0.3s ease;
        }
        
        .activity-log-row:hover {
            background-color: rgba(99, 102, 241, 0.1);
            transform: translateX(5px);
        }
        
        .filter-section {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 1rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .export-buttons button {
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .device-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .device-status.online {
            background-color: #10b981;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }
        
        .device-status.offline {
            background-color: #ef4444;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo-container">
                <i class="bi bi-qr-code-scan logo-icon"></i>
                <h4 class="logo-text">Entry Monitor</h4>
            </div>
            <button class="sidebar-toggle d-lg-none" id="sidebarClose">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        
        <nav class="sidebar-nav">
            <ul class="nav-list">
                <li class="nav-item active">
                    <a href="#" class="nav-link" data-page="dashboard">
                        <i class="bi bi-grid-fill"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="homeowners">
                        <i class="bi bi-people-fill"></i>
                        <span>Homeowners</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="activity-log">
                        <i class="bi bi-clock-history"></i>
                        <span>Activity Log</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="reports">
                        <i class="bi bi-file-earmark-bar-graph"></i>
                        <span>Reports</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="guards">
                        <i class="bi bi-shield-check"></i>
                        <span>Guard Management</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="devices">
                        <i class="bi bi-phone-fill"></i>
                        <span>Scanner Devices</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="audit-log">
                        <i class="bi bi-journal-text"></i>
                        <span>Audit Log</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="settings">
                        <i class="bi bi-gear-fill"></i>
                        <span>Settings</span>
                    </a>
                </li>
            </ul>
        </nav>
        
        <div class="sidebar-footer">
            <div class="user-profile">
                <div class="user-avatar">
                    <i class="bi bi-person-circle"></i>
                </div>
                <div class="user-info">
                    <h6><?php echo htmlspecialchars($user['name']); ?></h6>
                    <p><?php echo htmlspecialchars($user['role']); ?></p>
                </div>
            </div>
            <a href="../auth/login.php" class="logout-btn">
                <i class="bi bi-box-arrow-right"></i>
                <span>Logout</span>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Navigation Bar -->
        <nav class="topbar">
            <div class="topbar-left">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="bi bi-list"></i>
                </button>
                <div class="breadcrumb-container">
                    <h5 class="page-title">Dashboard</h5>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="#">Home</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Dashboard</li>
                        </ol>
                    </nav>
                </div>
            </div>
            
            <div class="topbar-right">
                <div class="search-box">
                    <i class="bi bi-search"></i>
                    <input type="text" placeholder="Search homeowners..." id="searchInput">
                </div>
                
                <div class="topbar-actions">
                    <button class="action-btn" id="notificationBtn">
                        <i class="bi bi-bell-fill"></i>
                        <span class="badge">3</span>
                    </button>
                    
                    <button class="action-btn" id="themeToggle">
                        <i class="bi bi-moon-stars-fill"></i>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Dashboard Content -->
        <div class="content-wrapper">
            <!-- Summary Stats Cards -->
            <div class="row g-4 mb-4">
                <div class="col-12 col-sm-6 col-xl-3">
                    <div class="stat-card stat-card-primary">
                        <div class="stat-icon">
                            <i class="bi bi-people"></i>
                        </div>
                        <div class="stat-content">
                            <h3 class="stat-value" id="totalHomeowners"><?php echo $totalHomeowners; ?></h3>
                            <p class="stat-label">Total Homeowners</p>
                            <div class="stat-trend neutral">
                                <i class="bi bi-person-check"></i>
                                <span>Active accounts</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-12 col-sm-6 col-xl-3">
                    <div class="stat-card stat-card-success">
                        <div class="stat-icon">
                            <i class="bi bi-house-check-fill"></i>
                        </div>
                        <div class="stat-content">
                            <h3 class="stat-value" id="currentlyInside"><?php echo $currentlyInside; ?></h3>
                            <p class="stat-label">Currently Inside</p>
                            <div class="stat-trend positive">
                                <i class="bi bi-arrow-down-circle"></i>
                                <span>In subdivision</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-12 col-sm-6 col-xl-3">
                    <div class="stat-card stat-card-warning">
                        <div class="stat-icon">
                            <i class="bi bi-house-dash-fill"></i>
                        </div>
                        <div class="stat-content">
                            <h3 class="stat-value" id="currentlyOutside"><?php echo $currentlyOutside; ?></h3>
                            <p class="stat-label">Currently Outside</p>
                            <div class="stat-trend neutral">
                                <i class="bi bi-arrow-up-circle"></i>
                                <span>Away from home</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-12 col-sm-6 col-xl-3">
                    <div class="stat-card stat-card-info">
                        <div class="stat-icon">
                            <i class="bi bi-arrow-down-square-fill"></i>
                        </div>
                        <div class="stat-content">
                            <h3 class="stat-value" id="totalEntriesToday"><?php echo $totalEntriesToday; ?></h3>
                            <p class="stat-label">Entries Today</p>
                            <div class="stat-trend positive">
                                <i class="bi bi-calendar-check"></i>
                                <span><?php echo date('M d, Y'); ?></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Second Row Stats -->
            <div class="row g-4 mb-4">
                <div class="col-12 col-sm-6 col-xl-3">
                    <div class="stat-card stat-card-danger">
                        <div class="stat-icon">
                            <i class="bi bi-arrow-up-square-fill"></i>
                        </div>
                        <div class="stat-content">
                            <h3 class="stat-value" id="totalExitsToday"><?php echo $totalExitsToday; ?></h3>
                            <p class="stat-label">Exits Today</p>
                            <div class="stat-trend neutral">
                                <i class="bi bi-calendar-check"></i>
                                <span><?php echo date('M d, Y'); ?></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-12 col-sm-6 col-xl-3">
                    <div class="stat-card stat-card-primary">
                        <div class="stat-icon">
                            <i class="bi bi-phone-fill"></i>
                        </div>
                        <div class="stat-content">
                            <h3 class="stat-value" id="activeDevices">2</h3>
                            <p class="stat-label">Active Scanners</p>
                            <div class="stat-trend positive">
                                <i class="bi bi-check-circle"></i>
                                <span>All online</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-12 col-sm-6 col-xl-3">
                    <div class="stat-card stat-card-success">
                        <div class="stat-icon">
                            <i class="bi bi-shield-check"></i>
                        </div>
                        <div class="stat-content">
                            <h3 class="stat-value" id="activeGuards">4</h3>
                            <p class="stat-label">Active Guards</p>
                            <div class="stat-trend positive">
                                <i class="bi bi-person-badge"></i>
                                <span>On duty</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-12 col-sm-6 col-xl-3">
                    <div class="stat-card stat-card-info">
                        <div class="stat-icon">
                            <i class="bi bi-activity"></i>
                        </div>
                        <div class="stat-content">
                            <h3 class="stat-value" id="totalScansToday"><?php echo $totalEntriesToday + $totalExitsToday; ?></h3>
                            <p class="stat-label">Total Scans Today</p>
                            <div class="stat-trend positive">
                                <i class="bi bi-graph-up"></i>
                                <span>All activities</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Real-time Activity Log -->
            <div class="row g-4 mb-4">
                <div class="col-12">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="bi bi-clock-history"></i>
                                Real-Time Activity Log
                            </h5>
                            <div class="card-actions">
                                <button class="btn btn-sm btn-outline-primary" id="refreshActivityLog">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0" id="activityLogTable">
                                    <thead>
                                        <tr>
                                            <th>Homeowner Name</th>
                                            <th>Homeowner ID</th>
                                            <th>Action</th>
                                            <th>Date</th>
                                            <th>Time</th>
                                            <th>Scanner Device</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Populated by JavaScript/AJAX -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Homeowner Status List -->
            <div class="row g-4 mb-4">
                <div class="col-12">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="bi bi-people"></i>
                                Homeowner Status
                            </h5>
                            <div class="card-actions">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-primary" data-filter="all">All</button>
                                    <button type="button" class="btn btn-sm btn-outline-success" data-filter="in">Inside</button>
                                    <button type="button" class="btn btn-sm btn-outline-danger" data-filter="out">Outside</button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0" id="homeownerStatusTable">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Homeowner ID</th>
                                            <th>Current Status</th>
                                            <th>Last Scan Time</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Populated by JavaScript/AJAX -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row g-4 mb-4">
                <div class="col-12 col-lg-8">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="bi bi-graph-up"></i>
                                Entry & Exit Analytics
                            </h5>
                            <div class="card-actions">
                                <select class="form-select form-select-sm" id="chartPeriod">
                                    <option value="7">Last 7 Days</option>
                                    <option value="30" selected>Last 30 Days</option>
                                    <option value="90">Last 90 Days</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <canvas id="entryExitChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="col-12 col-lg-4">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="bi bi-pie-chart-fill"></i>
                                Current Status Distribution
                            </h5>
                        </div>
                        <div class="card-body">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scanner Devices Status -->
            <div class="row g-4">
                <div class="col-12">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="bi bi-phone"></i>
                                Scanner Device Status
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6 col-lg-3">
                                    <div class="device-card">
                                        <span class="device-status online"></span>
                                        <strong>Main Gate Scanner</strong>
                                        <p class="mb-0 text-muted small">Last scan: 2 minutes ago</p>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-3">
                                    <div class="device-card">
                                        <span class="device-status online"></span>
                                        <strong>Back Gate Scanner</strong>
                                        <p class="mb-0 text-muted small">Last scan: 5 minutes ago</p>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-3">
                                    <div class="device-card">
                                        <span class="device-status offline"></span>
                                        <strong>Guard House Scanner</strong>
                                        <p class="mb-0 text-muted small">Offline since 1 hour ago</p>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-3">
                                    <div class="device-card">
                                        <span class="device-status online"></span>
                                        <strong>Mobile Scanner 1</strong>
                                        <p class="mb-0 text-muted small">Last scan: 10 minutes ago</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Action Button -->
    <button class="quick-action-btn" id="quickActionBtn" title="Quick Actions">
        <i class="bi bi-plus-lg"></i>
    </button>

    <!-- Add Homeowner Modal -->
    <div class="modal fade" id="addHomeownerModal" tabindex="-1" aria-labelledby="addHomeownerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addHomeownerModalLabel">
                        <i class="bi bi-person-plus"></i>
                        Add New Homeowner
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addHomeownerForm">
                        <div class="mb-3">
                            <label for="homeownerName" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="homeownerName" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="homeownerId" class="form-label">Homeowner ID</label>
                            <input type="text" class="form-control" id="homeownerId" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="homeownerEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="homeownerEmail" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="homeownerPhone" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="homeownerPhone" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="homeownerAddress" class="form-label">Address</label>
                            <textarea class="form-control" id="homeownerAddress" rows="2" required></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="generateQR" checked>
                                <label class="form-check-label" for="generateQR">
                                    Generate QR Code automatically
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveHomeownerBtn">
                        <i class="bi bi-save"></i>
                        Save Homeowner
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <!-- DataTables -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <!-- Custom JS -->
    <script src="dashboard.js"></script>
    
    <script>
        // Initialize DataTables
        $(document).ready(function() {
            // Activity Log Table
            const activityTable = $('#activityLogTable').DataTable({
                ajax: {
                    url: 'api/get_activity_log.php',
                    dataSrc: ''
                },
                columns: [
                    { data: 'homeowner_name' },
                    { data: 'homeowner_id' },
                    { 
                        data: 'action',
                        render: function(data) {
                            if (data === 'IN') {
                                return '<span class="status-badge-in"><i class="bi bi-arrow-down-circle"></i> IN</span>';
                            } else {
                                return '<span class="status-badge-out"><i class="bi bi-arrow-up-circle"></i> OUT</span>';
                            }
                        }
                    },
                    { data: 'date' },
                    { data: 'time' },
                    { data: 'device' }
                ],
                order: [[3, 'desc'], [4, 'desc']],
                pageLength: 10,
                responsive: true
            });
            
            // Homeowner Status Table
            const statusTable = $('#homeownerStatusTable').DataTable({
                ajax: {
                    url: 'api/get_homeowner_status.php',
                    dataSrc: ''
                },
                columns: [
                    { data: 'name' },
                    { data: 'homeowner_id' },
                    { 
                        data: 'current_status',
                        render: function(data) {
                            if (data === 'IN') {
                                return '<span class="status-badge-in"><i class="bi bi-house-check"></i> INSIDE</span>';
                            } else {
                                return '<span class="status-badge-out"><i class="bi bi-house-dash"></i> OUTSIDE</span>';
                            }
                        }
                    },
                    { data: 'last_scan_time' },
                    {
                        data: null,
                        render: function(data) {
                            return `
                                <button class="btn btn-sm btn-outline-primary" onclick="viewHomeowner('${data.id}')">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning" onclick="editHomeowner('${data.id}')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                            `;
                        }
                    }
                ],
                pageLength: 10,
                responsive: true
            });
            
            // Refresh activity log every 30 seconds
            setInterval(function() {
                activityTable.ajax.reload(null, false);
                statusTable.ajax.reload(null, false);
                updateStats();
            }, 30000);
            
            // Manual refresh button
            $('#refreshActivityLog').click(function() {
                activityTable.ajax.reload();
                updateStats();
            });
            
            // Filter buttons for homeowner status
            $('[data-filter]').click(function() {
                const filter = $(this).data('filter');
                if (filter === 'all') {
                    statusTable.search('').draw();
                } else if (filter === 'in') {
                    statusTable.search('INSIDE').draw();
                } else if (filter === 'out') {
                    statusTable.search('OUTSIDE').draw();
                }
                
                $('[data-filter]').removeClass('active');
                $(this).addClass('active');
            });
        });
        
        // Update statistics
        function updateStats() {
            fetch('api/get_stats.php')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('totalHomeowners').textContent = data.total_homeowners;
                    document.getElementById('currentlyInside').textContent = data.currently_inside;
                    document.getElementById('currentlyOutside').textContent = data.currently_outside;
                    document.getElementById('totalEntriesToday').textContent = data.total_entries_today;
                    document.getElementById('totalExitsToday').textContent = data.total_exits_today;
                    document.getElementById('totalScansToday').textContent = data.total_scans_today;
                });
        }
        
        // Initialize Charts
        const ctx1 = document.getElementById('entryExitChart').getContext('2d');
        const entryExitChart = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Entries',
                    data: [],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Exits',
                    data: [],
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                }
            }
        });
        
        const ctx2 = document.getElementById('statusChart').getContext('2d');
        const statusChart = new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: ['Inside', 'Outside'],
                datasets: [{
                    data: [<?php echo $currentlyInside; ?>, <?php echo $currentlyOutside; ?>],
                    backgroundColor: ['#10b981', '#ef4444']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom'
                    }
                }
            }
        });
        
        // Load chart data
        function loadChartData(period) {
            fetch(`api/get_chart_data.php?period=${period}`)
                .then(response => response.json())
                .then(data => {
                    entryExitChart.data.labels = data.labels;
                    entryExitChart.data.datasets[0].data = data.entries;
                    entryExitChart.data.datasets[1].data = data.exits;
                    entryExitChart.update();
                });
        }
        
        // Chart period change
        document.getElementById('chartPeriod').addEventListener('change', function() {
            loadChartData(this.value);
        });
        
        // Initial load
        loadChartData(30);
        
        // Quick action button
        document.getElementById('quickActionBtn').addEventListener('click', function() {
            const modal = new bootstrap.Modal(document.getElementById('addHomeownerModal'));
            modal.show();
        });
        
        // Save homeowner
        document.getElementById('saveHomeownerBtn').addEventListener('click', function() {
            // Implementation for saving homeowner
            alert('Homeowner save functionality will be implemented with backend API');
        });
        
        // View and Edit functions
        function viewHomeowner(id) {
            window.location.href = `homeowner_details.php?id=${id}`;
        }
        
        function editHomeowner(id) {
            window.location.href = `edit_homeowner.php?id=${id}`;
        }
    </script>
</body>
</html>
